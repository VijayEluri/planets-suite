<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:p="http://planets-project.eu/taglibs/plato"
	template="../template.xhtml">
	<ui:define name="title">
      PLANETS Preservation Planning Tool - Identify Requirements
   </ui:define>

	<ui:define name="scripts">
		<script type="text/javascript">
function fillNodeName(sameRowComponent,thevalue) {
  nameId = sameRowComponent.getAttribute('id');
  /* cut off the own name: copy all chars including the ':' substring(startIdx, numOfChars) */
  targetId = nameId.substring(0, nameId.lastIndexOf(':') + 1) + 'name';
  targetNode = document.getElementById(targetId);
  if (targetNode.value == '')
     targetNode.value = thevalue;
  return true;
}      
  
</script>
	</ui:define>

	<ui:define name="content">

		<f:facet name="aroundInvalidField">
			<s:span styleClass="errors">
				<s:message styleClass="errors" />
			</s:span>
		</f:facet>
   <rich:modalPanel id="propertyMappingEditor" autosized="true" width="600" >
        <f:facet name="header">
            <h:outputText value="Edit object property mapping for: #{mpmSelectedLeaf.name}" />
        </f:facet>
	<f:facet name="controls">
	    <h:graphicImage id="closeMapping" 
		value="../img/icons/big/cancel.png"
		title="Close" width="16" height="16"
		onclick="Richfaces.hideModalPanel('propertyMappingEditor')" />
        </f:facet>
        <h:form id="propertyMappingForm"> 
            <s:div rendered="#{(mappingStatus.value == null) and (mpmSelectedLeaf.mapped)}">
                 <s:div rendered="#{mpmSelectedLeaf.mapped}">
                     <fieldset>
                     	<legend>Measurement Info</legend>
                        <h:outputText value="Name: #{mpmSelectedLeaf.measurementInfo.uri}"/>
                     </fieldset>
                     <fieldset>
                     	<legend>Property</legend>
                        <h:outputText value="Category: #{mpmSelectedLeaf.measurementInfo.property.category}"/><br/>
                        <h:outputText value="Name: #{mpmSelectedLeaf.measurementInfo.property.name}"/><br/>
                        <h:outputText value="Description:"/><br/>
                        <h:inputTextarea rows="3" readonly="true"
                             value="#{mpmSelectedLeaf.measurementInfo.property.description}"
                             style="width:95%;"/>
                     </fieldset>
                     <s:div rendered="#{mpmSelectedLeaf.measurementInfo.metric != null}">
	                     <fieldset>
     						<legend>Metric</legend>
	                        <h:outputText value="Metric: #{mpmSelectedLeaf.measurementInfo.metric.name}" /><br/>
	                        <h:outputText value="Description:"/><br/>
	                        <h:inputTextarea rows="3" readonly="true"
	                             value="#{mpmSelectedLeaf.measurementInfo.metric.description}"
	                             style="width:95%;"/>
                         </fieldset>
                     </s:div>
                     <fieldset>
                     	<legend>Measure</legend>
                        <h:outputText value="Scale: #{mpmSelectedLeaf.measurementInfo.scale.displayName}"/><br/>
                        <h:outputText value="Unit: #{mpmSelectedLeaf.measurementInfo.unit}"/><br/>
                     </fieldset>
                 </s:div>
                 <div>
                 	<div>
                     <a4j:commandLink id="editMapping" 
                         action="#{measurablePropertyMapper.editMapping()}" style="color: #FFFFFF;"
                         reRender="propertyMappingForm"
                         rendered="#{not empty mappingCategory}"
                         eventsQueue="ajaxQ">
                       
                       <h:graphicImage
                           value="../img/go-next.png"
                           title="Edit Mapping" width="32" height="32" />
                     </a4j:commandLink>
                     </div>
                     <div>
                     <a4j:commandLink id="removeMapping" 
                         action="#{measurablePropertyMapper.removeMapping()}" style="color: #FFFFFF;"
                         reRender="propertyMappingForm,objectivetree"
                         rendered="#{not empty mappingCategory}"
                         eventsQueue="ajaxQ">
                       <h:graphicImage
                           value="../img/treetable/trash-node.png"
                           title="Remove Mapping" width="32" height="32" />
                     </a4j:commandLink>
                     </div>
                     
                 </div>
              </s:div>
              <!-- end mapping status: empty  -->

              <!-- mapping status: category  -->
              <s:div rendered="#{(mappingStatus.value == 'category') or((empty mappingStatus.value) and (not mpmSelectedLeaf.mapped))}">
                 <fieldset>
                 	<legend>Criterion Category</legend>
                 	<div>
	                    <h:selectOneMenu 
	                        value="#{measurablePropertyMapper.selectedCategory}" id="mappingCategorySelect">
	                           <f:selectItems value="#{categoriesModel}"/>
	                       <a4j:support event="onchange" action="#{measurablePropertyMapper.selectionChanged}" eventsQueue="ajaxQ"/>
	                     </h:selectOneMenu>
	                 </div>
                     <div>
                     <h3>Description:</h3>
                     	<ul>
                     		<li><b>Outcome Object:</b> Desired properties of the object such as editability and properties of the original that need to be preserved, such as image width</li>
                     		<li><b>Outcome Format:</b> Criteria on the format the objects will be stored in, such as standardisation</li>
                     		<li><b>Outcome Effects:</b> Effects induced by the preservation action, such as costs</li>
                     		<li><b>Action Runtime:</b> Runtime properties such as used time and memory</li>
                     		<li><b>Action Static:</b> Action properties such as licensing costs and documentation quality</li>
                     		<li><b>Action Judgement:</b>  Properties that need to be judged, such as usability</li>
                     	</ul>
                     </div>
                 </fieldset>
                 <div>
                     <a4j:commandLink id="editProperty" style="color: #FFFFFF;"
                     	 action="#{measurablePropertyMapper.editProperty()}" reRender="propertyMappingForm"
                     	 eventsQueue="ajaxQ">
                       <h:graphicImage
                           value="../img/go-next.png"
                           title="Edit Property" width="32" height="32" />
                     </a4j:commandLink>
                 </div>
              </s:div>

              <!-- mapping status: property -->
              <s:div rendered="#{(mappingStatus.value == 'property')}">
              	<fieldset>
              		<legend>Property</legend>
                    <h:selectOneMenu 
                        value="#{measurablePropertyMapper.selectedProperty}" id="idObjectProperty" >
                           <f:selectItems  value="#{propertiesModel}" />
                        <a4j:support event="onchange" reRender="panelProperty,navi" eventsQueue="ajaxQ"/>
                    </h:selectOneMenu>
	                <s:div id="panelProperty">
	                    <s:div rendered="#{mappingProperty != null}">
                           <h:outputText value="PropertyId: #{mappingProperty.propertyId}"/> <br/>
                           <h:outputText value="Description:"/>
                           <br/>
                           <h:inputTextarea rows="3" readonly="true"
                                id="idopdescr"
                                value="#{mappingProperty.description}"
                                rendered="#{mappingProperty != null}"
                                style="width:99%;"/>

 						  <h:outputText value="Scale: #{mappingProperty.scale.displayName}" rendered="#{mappingProperty.scale != null}"/><br/>
 						  <h:outputText value="Unit: #{mappingProperty.scale.unit}" rendered="#{mappingProperty.scale != null}"/>
	                     </s:div>
	                </s:div>
              	</fieldset>
                 <s:div id="navi">
                     <a4j:commandLink id="editMetric" style="color: #FFFFFF;"
                         disabled="#{mappingProperty == null}" 
                         action="#{measurablePropertyMapper.editMetric()}"
                         rendered="#{not empty mappingProperty.possibleMetrics}"
                         reRender="propertyMappingForm"
                         eventsQueue="ajaxQ">
                       <h:graphicImage
                           value="../img/go-next.png"
                           title="Edit Metric" width="32" height="32" />
                     </a4j:commandLink>
                     <a4j:commandLink id="savePropertyMapping" style="color: #FFFFFF;"
                         disabled="#{mappingProperty == null}" 
                         action="#{measurablePropertyMapper.savePropertyMapping()}"
                         reRender="propertyMappingForm,objectivetree"
                         rendered="#{not empty mappingProperty.scale}"
                         onclick="Richfaces.hideModalPanel('propertyMappingEditor')"
                         eventsQueue="ajaxQ">
                         <h:graphicImage
                             value="../img/icons/big/apply.png"
                             title="Save Property mapping" width="32" height="32" />
                     </a4j:commandLink>
                 </s:div>
                </s:div>
                
                <!-- mapping status = metric -->
                <s:div rendered="#{(mappingStatus.value == 'metric')}">
                   <fieldset>
                      <legend>Property</legend>
                      <h:outputText value="Category: #{mappingProperty.category}"/><br/>
                      <h:outputText value="Name: #{mappingProperty.name}"/><br/>
                      <h:outputText value="Description:"/>
                      <br/>
                      <h:inputTextarea rows="3" readonly="true"
                           value="#{mappingProperty.description}"
                           style="width:99%;"/>
                   </fieldset>
                   <fieldset>
                   		<legend>Metric</legend>
                     <h:selectOneMenu 
                        value="#{measurablePropertyMapper.selectedMetric}" id="idMappingMetric">   
                        <f:selectItems value="#{metricsModel}" />
                        <a4j:support event="onchange" reRender="panelMetric,metricnavi" eventsQueue="ajaxQ"/>
                     </h:selectOneMenu>
                     <s:div id="panelMetric">
                         <s:div rendered="#{mappingMetric != null}">
                              <div>
                                <h:outputText value="Description:"/>
                                <br/>
                                <h:inputTextarea rows="3" readonly="true"
                                     id="idmdescr"
                                     value="#{mappingMetric.description}"
                                     rendered="#{mappingMetric != null}"
                                     style="width:99%;"/>
                              </div>
	 						  <h:outputText value="Scale: #{mappingMetric.scale.displayName}" rendered="#{mappingMetric.scale != null}"/><br/>
	 						  <h:outputText value="Unit: #{mappingMetric.scale.unit}" rendered="#{mappingMetric.scale != null}"/>
                         </s:div>
                     </s:div>
                   </fieldset>
                 <s:div id="metricnavi">
                     <a4j:commandLink id="saveMapping" style="color: #FFFFFF;"
                         disabled="#{mappingMetric == null}" 
                         action="#{measurablePropertyMapper.savePropertyMapping()}"
                         onclick="Richfaces.hideModalPanel('propertyMappingEditor')"
                         reRender="propertyMappingForm,objectivetree"
                         eventsQueue="ajaxQ">
                         <h:graphicImage
                             value="../img/icons/big/apply.png"
                             title="Save" width="32" height="32" />
                     </a4j:commandLink>
                 </s:div>
             </s:div>
         </h:form>            
   </rich:modalPanel>


		<h1>Identify Requirements</h1>
		<div id="anchors">
		<ul>
			<li><a href="identrequirements.xhtml#knowledgebase">Knowledge Base</a></li>
			<li><a href="identrequirements.xhtml#objectivetree">Objective Tree</a></li>
			<li><a href="identrequirements.xhtml#description">Description</a></li>
			<li><a href="identrequirements.xhtml#uploads">Uploads</a></li>
		</ul>
		</div>
		<div class="margin-bottom-huge"><p:help
			url="/plato/help/tree.html"
			text="How can I define the objective tree?" /> <p:help
			url="/plato/help/templates.html"
			text="How can I use the knowledge base?" /></div>

		<div class="margin-bottom-huge;overflow:scroll"><a
			href="knowledgebase" /> <rich:modalPanel id="savePanel" width="700"
			height="400" autosized="false" style="overflow:scroll">

			<f:facet name="header">
				<h:outputText
					value="Please select a target node in the knowledge base" />
			</f:facet>
			<f:facet name="controls">
				<a4j:form id="cancelFragmentForm">
					<a4j:commandLink
						action="#{identifyRequirements.cancelFragmentOperation()}"
						oncomplete="Richfaces.hideModalPanel('savePanel');" value="Close"
						eventsQueue="ajaxQ">
					</a4j:commandLink>
				</a4j:form>
			</f:facet>
			<h:form id="saveFragmentForm">
				<s:div id="saveDiv">

					<p:help url="/plato/help/templates.html"
						text="How can I use the template library? " />
					<p>You can change name and description of the fragment before
					saving.</p>
					<p>To complete the operation and store the tree, select the
					target node in the library to which you want to add the tree. The
					popup window will close, and a copy of your tree is stored in the
					public library and accessible to all users.</p>
					<h:inputText
						style="border:1px solid #DDDDDD; width:100%; background-color: #{empty(tempNode.name)? '#F08080':'white'};"
						required="true"
						onblur="this.style.backgroundColor = (this.value==null||this.value=='')?'#F08080':'white';"
						onkeypress="this.style.backgroundColor = (this.value==null||this.value=='')?'#F08080':'white';"
						requiredMessage="Please provide a name." id="name"
						value="#{tempNode.name}">
					</h:inputText>
					<br />
					<h:inputTextarea id="description" rows="3"
						value="#{tempNode.description}" style="width: 100%;">
						<f:validateLength maximum="32672" />
					</h:inputTextarea>
					<br />
					<a4j:commandButton id="savetemp" value="Save name and description"
						actionListener="#{identifyRequirements.saveTemp}"
						eventsQueue="ajaxQ">
					</a4j:commandButton>
					<hr />

					<rich:tree id="saveTree" switchType="ajax" immediate="true"
						adviseNodeOpened="#{treeHelper.adviseNodeOpened}">

						<rich:recursiveTreeNodesAdaptor roots="#{fragmentRoot.root}"
							var="node" nodes="#{node.children}">

							<rich:treeNode styleClass="treenode"
								highlightedClass="highlighted" iconLeaf="" icon="">
								<div class="treetable_cell" style="width: 80px;">

								<div style="float: left; width: 200px"><!-- save tree/branch/node into library  -->
								<a4j:commandLink rendered="#{(!node.leaf)}"
									actionListener="#{identifyRequirements.saveFragmentHere(node)}"
									value="#{node.name}" reRender="savePanel"
									oncomplete="Richfaces.hideModalPanel('savePanel');"
									eventsQueue="ajaxQ">
								</a4j:commandLink> <!-- we are about to save, but not into a leaf  --> <h:outputText
									rendered="#{node.leaf}" value="#{node.name}" /></div>
								</div>
							</rich:treeNode>
						</rich:recursiveTreeNodesAdaptor>
					</rich:tree>
				</s:div>
			</h:form>
		</rich:modalPanel> <rich:modalPanel id="saveTreePanel" width="700" height="400"
			autosized="false" style="overflow:scroll">

			<f:facet name="header">
				<h:outputText
					value="Please select a target node in the knowledge base" />
			</f:facet>
			<f:facet name="controls">
				<a4j:form id="cancelTreeForm">
					<a4j:commandLink
						action="#{identifyRequirements.cancelFragmentOperation()}"
						oncomplete="Richfaces.hideModalPanel('saveTreePanel');"
						value="Close"
						eventsQueue="ajaxQ">
					</a4j:commandLink>
				</a4j:form>
			</f:facet>
			<h:form id="saveTreeForm">
				<s:div id="saveTreeDiv">

					<p:help url="/plato/help/templates.html"
						text="How can I use the template library? " />
					<p>You can change name and description of the tree before
					saving.</p>
					<h:inputText
						style="border:1px solid #DDDDDD; width:100%; background-color: #{empty(tempNode.name)? '#F08080':'white'};"
						required="true"
						onblur="this.style.backgroundColor = (this.value==null||this.value=='')?'#F08080':'white';"
						onkeypress="this.style.backgroundColor = (this.value==null||this.value=='')?'#F08080':'white';"
						requiredMessage="Please provide a name." id="name"
						value="#{tempNode.name}">
					</h:inputText>
					<br />
					<h:inputTextarea id="description" rows="3"
						value="#{tempNode.description}" style="width: 100%;">
						<f:validateLength maximum="32672" />
					</h:inputTextarea>
					<br />
					<a4j:commandButton id="savetemp" value="Save name and description"
						actionListener="#{identifyRequirements.saveTemp}"
						eventsQueue="ajaxQ">
					</a4j:commandButton>

					<p>To complete the operation and store the tree, select the
					target node in the library to which you want to add the tree. The
					popup window will close, and a copy of your tree is stored in the
					public library and accessible to all users.</p>

					<hr />
					<rich:tree id="saveTreeTree" switchType="ajax" immediate="true"
						adviseNodeOpened="#{treeHelper.adviseNodeOpened}">

						<rich:recursiveTreeNodesAdaptor roots="#{templateRoot.root}"
							var="node" nodes="#{node.children}">

							<rich:treeNode styleClass="treenode"
								highlightedClass="highlighted" iconLeaf="" icon="">
								<div class="treetable_cell" style="width: 80px;">

								<div style="float: left; width: 200px"><!-- save tree/branch/node into library  -->
								<a4j:commandLink rendered="#{(!node.leaf)}"
									actionListener="#{identifyRequirements.saveFragmentHere(node)}"
									value="#{node.name}" reRender="savePanel"
									oncomplete="Richfaces.hideModalPanel('saveTreePanel');"
									eventsQueue="ajaxQ">
								</a4j:commandLink> <!-- we are about to save, but not into a leaf  --> <h:outputText
									rendered="#{node.leaf}" value="#{node.name}" /></div>
								</div>
							</rich:treeNode>
						</rich:recursiveTreeNodesAdaptor>
					</rich:tree>
				</s:div>
			</h:form>
		</rich:modalPanel> <rich:modalPanel id="insertPanel" width="700" height="400"
			autosized="false" style="overflow:scroll">

			<f:facet name="header">
				<h:outputText
					value="Please select the node to insert from the knowledge base" />
			</f:facet>
			<f:facet name="controls">
				<a4j:form id="cancelInsertForm">
					<a4j:commandLink
						action="#{identifyRequirements.cancelFragmentOperation()}"
						oncomplete="Richfaces.hideModalPanel('insertPanel');"
						value="Close"
						eventsQueue="ajaxQ">
					</a4j:commandLink>
				</a4j:form>
			</f:facet>
			<h:form id="insertFragmentForm">
				<s:div id="insertDiv">

					<p:help url="/plato/help/templates.html"
						text="How can I use the template library? " />

					<rich:tree id="insertTree" switchType="ajax" immediate="true"
						adviseNodeOpened="#{treeHelper.adviseNodeOpened}">

						<rich:recursiveTreeNodesAdaptor roots="#{fragmentRoot.root}"
							var="node" nodes="#{node.children}">

							<rich:treeNode styleClass="treenode"
								highlightedClass="highlighted" iconLeaf="" icon="">
								<div class="treetable_cell" style="width: 80px;">

								<div style="float: left; width: 200px"><!-- select a branch/leaf/tree for insertion into the objective tree -->
								<a4j:commandLink
									actionListener="#{identifyRequirements.insertThisFragment(node)}"
									ajaxSingle="true" value="#{node.name}"
									oncomplete="Richfaces.hideModalPanel('insertPanel');changed();"
									reRender="richTree"
									eventsQueue="ajaxQ">
								</a4j:commandLink></div>
								</div>
								
									<ui:include src="shared/nodeInfosKB.xhtml"/>									
								
							</rich:treeNode>
						</rich:recursiveTreeNodesAdaptor>
					</rich:tree>
				</s:div>
			</h:form>
		</rich:modalPanel> 
		<rich:modalPanel id="templatePanel" width="700" height="400"
			autosized="false" style="overflow:scroll">

			<f:facet name="header">
				<h:outputText
					value="Please select the template to use from the knowledge base" />
			</f:facet>
			<f:facet name="controls">
				<a4j:form id="cancelTemplateForm">
					<a4j:commandLink
						action="#{identifyRequirements.cancelFragmentOperation()}"
						oncomplete="Richfaces.hideModalPanel('templatePanel');"
						value="Close"
						eventsQueue="ajaxQ">
					</a4j:commandLink>
				</a4j:form>
			</f:facet>
			<h:form id="templateForm">

				<s:div id="templateDiv">

					<p:help url="/plato/help/templates.html"
						text="How can I use the template library? " />

					<rich:tree id="templateTree" switchType="ajax" immediate="true"
						adviseNodeOpened="#{treeHelper.adviseNodeOpened}">

						<rich:recursiveTreeNodesAdaptor roots="#{templateRoot.root}"
							var="node" nodes="#{node.children}">

							<rich:treeNode styleClass="treenode"
								highlightedClass="highlighted" iconLeaf="" icon="">
								<div class="treetable_cell" style="width: 80px;">

								<div style="float: left; width: 200px">
								<a4j:commandLink
									actionListener="#{identifyRequirements.useTemplate(node)}"
									ajaxSingle="true" value="#{node.name}"
									oncomplete="Richfaces.hideModalPanel('templatePanel');changed();"
									reRender="richTree"
									eventsQueue="ajaxQ">
								</a4j:commandLink> <!-- select a branch/leaf/tree for insertion into the objective tree -->
								</div>
								</div>
							
								
								<ui:include src="shared/nodeInfosKB.xhtml"/>

							</rich:treeNode>
						</rich:recursiveTreeNodesAdaptor>
					</rich:tree>
				</s:div>
			</h:form>
		</rich:modalPanel> 


		<rich:modalPanel id="templateEditorPanel" width="700" height="400"
			autosized="false" style="overflow:scroll">

			<f:facet name="header">
				<h:outputText
					value="Admin view for cleaning up the knowledge base" />
			</f:facet>
			<f:facet name="controls">
				<a4j:form id="cancelEditorTemplateForm">
					<a4j:commandLink
						action="#{identifyRequirements.saveLibrary()}"
						oncomplete="Richfaces.hideModalPanel('templateEditorPanel');"
						value="Save and close"
						eventsQueue="ajaxQ">
					</a4j:commandLink>
				</a4j:form>
			</f:facet>
			<h:form id="templateEditorForm">

				<s:div id="templateDiv">

					<rich:tree id="templateEditorTree" switchType="ajax" immediate="true"
						adviseNodeOpened="#{treeHelper.adviseNodeOpened}">

						<rich:recursiveTreeNodesAdaptor roots="#{templateRoot.root}"
							var="node" nodes="#{node.children}">

							<rich:treeNode styleClass="treenode"
								highlightedClass="highlighted" iconLeaf="" icon="">
								<div class="treetable_cell" style="width: 80px;">

								<div style="float: left; width: 200px">
								<s:div rendered="#{user.admin}" style="float: left; width: 20px">
									<a4j:commandLink id="removeLibraryNode" 
									    rendered="#{node.parent!=null}"
										action="#{identifyRequirements.remove(node)}"
										reRender="templateDiv"
										eventsQueue="editorQ">
											<h:graphicImage value="../img/treetable/trash-node.png"
												width="16" height="16" />
										</a4j:commandLink>
								</s:div>

								<h:outputText value="#{node.name}"/>
								</div>
								</div>
								
								<ui:include src="shared/nodeInfosKB.xhtml"/>

							</rich:treeNode>
						</rich:recursiveTreeNodesAdaptor>
					</rich:tree>
				</s:div>
			</h:form>
		</rich:modalPanel> 


		<rich:modalPanel id="fragmentEditorPanel" width="700" height="400"
			autosized="false" style="overflow:scroll">

			<f:facet name="header">
				<h:outputText
					value="Admin view for cleaning up the knowledge base" />
			</f:facet>
			<f:facet name="controls">
				<a4j:form id="cancelEditorFragmentForm">
					<a4j:commandLink
						action="#{identifyRequirements.saveLibrary()}"
						oncomplete="Richfaces.hideModalPanel('fragmentEditorPanel');"
						value="Save and close"
						eventsQueue="ajaxQ">
					</a4j:commandLink>
				</a4j:form>
			</f:facet>
			<h:form id="fragmentEditorForm">

				<s:div id="fragmentDiv">

					<rich:tree id="fragmentEditorTree" switchType="ajax" immediate="true"
						adviseNodeOpened="#{treeHelper.adviseNodeOpened}">

						<rich:recursiveTreeNodesAdaptor roots="#{fragmentRoot.root}"
							var="node" nodes="#{node.children}">

							<rich:treeNode styleClass="treenode"
								highlightedClass="highlighted" iconLeaf="" icon="">
								<div class="treetable_cell" style="width: 80px;">

								<div style="float: left; width: 200px">
								<s:div rendered="#{user.admin}" style="float: left; width: 20px">
									<a4j:commandLink id="removeLibraryNode" 
									    rendered="#{node.parent!=null}"
										action="#{identifyRequirements.remove(node)}"
										reRender="fragmentDiv"
										eventsQueue="editorQ">
											<h:graphicImage value="../img/treetable/trash-node.png"
												width="16" height="16" />
										</a4j:commandLink>
								</s:div>
								<h:outputText value="#{node.name}"/>
								</div>
								</div>
								
								<ui:include src="shared/nodeInfosKB.xhtml"/>

							</rich:treeNode>
						</rich:recursiveTreeNodesAdaptor>
					</rich:tree>
				</s:div>
			</h:form>
		</rich:modalPanel> 

		<a4j:form id="mainform">

			<h:inputText id="changedflag" value="#{changed}" style="display:none" />

			<fieldset id="library" class="size-full"><legend>
			<ui:include src="../legend_nav.xhtml">
			</ui:include> <h:outputText value="Knowledge base" /> </legend> 
			<a4j:commandButton
				id="useTree" value="Load a template tree"
				actionListener="#{identifyRequirements.initTemplates}"
				reRender="templatePanel"
				oncomplete="Richfaces.showModalPanel('templatePanel',{top:'100px'});"
				eventsQueue="ajaxQ">
			</a4j:commandButton> 
			<a4j:commandButton id="storeTree"
				value="Save current tree as template"
				actionListener="#{identifyRequirements.selectTreeForSaving}"
				reRender="saveTreePanel"
				oncomplete="Richfaces.showModalPanel('saveTreePanel',{top:'100px'});"
				eventsQueue="ajaxQ">
			</a4j:commandButton>
			<a4j:commandButton
				id="editTemplates" value="Edit templates"
				actionListener="#{identifyRequirements.initTemplates}"
				reRender="templateEditorPanel"
				rendered="#{user.admin}"
				oncomplete="Richfaces.showModalPanel('templateEditorPanel',{top:'100px'});"
				eventsQueue="ajaxQ">
			</a4j:commandButton> 
			<a4j:commandButton
				id="editFragments" value="Edit fragments"
				actionListener="#{identifyRequirements.initFragments}"
				reRender="fragmentEditorPanel"
				rendered="#{user.admin}"
				oncomplete="Richfaces.showModalPanel('fragmentEditorPanel',{top:'100px'});"
				eventsQueue="ajaxQ">
			</a4j:commandButton> 
			</fieldset>
			<fieldset id="objectivetreeRich" class="size-full"><legend>
			<ui:include src="../legend_nav.xhtml"></ui:include> <h:outputText
				value="Objective Tree" /> </legend>
			<div><h:outputText value="Edit: " /> <h:selectOneMenu
				value="#{doEditNodeComments.bool}">
				<f:selectItem itemValue="true" itemLabel="Comments" />
				<f:selectItem itemValue="false" itemLabel="Scale, restriction, unit" />
				<a4j:support event="onchange" reRender="objectivetree" eventsQueue="ajaxQ"/>
			</h:selectOneMenu></div>

			<s:div id="objectivetree">
				<p>
				<a4j:commandLink actionListener="#{treeHelper.expandAll}"
					ajaxSingle="true" value="Expand all" reRender="richTree" eventsQueue="ajaxQ"/></p>
				<div id="treeheader" style="padding-top: 5px;">
					<div class="treetable_cell" style="width: 420px;text-align:center">
						<b>Node</b>
					</div>
					<div class="treetable_nodeInfo" style="width: 550px;text-align:center">
						<s:div rendered="#{not doEditNodeComments.bool}" 
						    styleClass="treetable_cell" style="width: 545px;">
						    
							<div class="treetable_cell" style="text-align: center; width: 80px;"><b>Edit</b></div>
							<div class="treetable_cell" style="width: 30px;"><b>Single</b></div>
							<div class="treetable_cell" style="width: 120px;"><b>Scale</b></div>
							<div class="treetable_cell" style="width: 230px;text-align:center;"><b>Restriction</b></div>
							<div class="treetable_cell" style="width: 60px;text-align:center;"><b>Unit</b></div>
							
						</s:div>
						<s:div rendered="#{doEditNodeComments.bool}" styleClass="treetable_cell" style="text-align:center;padding-left:200px;">
							<b>Description</b>
						</s:div>
					</div>
				</div>
				<div id="treecontent" style="clear: both;">
				<rich:tree
					id="richTree" switchType="client" immediate="true"
					showConnectingLines="false"
					adviseNodeOpened="#{treeHelper.adviseNodeOpened}"
					style="padding-top:10px;">

					<rich:recursiveTreeNodesAdaptor roots="#{selectedPlan.tree.root}"
						var="node" nodes="#{node.children}">
						<rich:treeNode highlightedClass="highlighted" iconLeaf="" icon="">
							<div class="treetable_cell" style="height: #{doEditNodeComments.bool?75:25}px; width: 40px;">
								<s:decorate id="nameDecorate">
								<div class="inputDecorate"><span class="#{invalid?'errors':''}"> <s:validateAll>
									<h:inputText
										style="border:1px solid #DDDDDD; width:270px; background-color: #{empty(node.name)? '#F08080':'white'};"
										onblur="this.style.backgroundColor = (this.value==null||this.value=='')?'#F08080':'white';"
										onkeypress="this.style.backgroundColor = (this.value==null||this.value=='')?'#F08080':'white';"
										required="true" requiredMessage="Please provide a name."
										id="name" value="#{node.name}">
										<f:validateLength maximum="255" minimum="1" />
										<a4j:support onsubmit="changed();" event="onchange"
											action="#{node.touch}" 
											eventsQueue="ajaxQ"/>
									</h:inputText>
								</s:validateAll></span>
								 <s:message styleClass="errorMessage" /></div>
								</s:decorate>
								
								<s:div rendered="#{doEditNodeComments.bool and node.leaf and (node.scale != null)}"
								style="white-space:normal;width:400px;">
									<h:outputText value="#{node.scale.displayName}  " />
									<h:outputText rendered="#{node.scale.restricted}" value="#{node.scale.restriction}  " />
									<h:outputText value="[#{node.scale.unit}]" rendered="#{not empty(node.scale.unit)}" />
									<br/>
									<h:outputText value="#{(node.mapped ? (node.measurementInfo.uri):'')}"/>
								</s:div>
							</div>
							<div class="treetable_nodeInfo" style="width:530px;">
							<s:div styleClass="treetable_cell" style="width:50px;" rendered="#{not doEditNodeComments.bool}">
								<h:panelGrid id="menuPanel" columns="2" border="0">
									<rich:dropDownMenu menuitem="menuNode" submitMode="ajax"
										direction="bottom-right" jointPoint="tr" hideDelay="500" >
										<f:facet name="label">
											<h:graphicImage
												value="../img/icons/small/preferences-system.png"
												id="addLeafpic" />
										</f:facet>
										<rich:menuItem id="addLeaf" rendered="#{!node.leaf}"
											action="#{identifyRequirements.addLeaf(node)}"
											value="Add a leaf node" onclick="changed();"
											reRender="richTree"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/treetable/add-leaf.png"
													width="16" height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="addNode" rendered="#{!node.leaf}"
											action="#{identifyRequirements.addNode(node)}"
											value="Add an inner node" onclick="changed();"
											reRender="richTree"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/treetable/add-node.png"
													width="16" height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="removeNode" rendered="#{node.parent!=null}"
											value="Remove" action="#{identifyRequirements.remove(node)}"
											reRender="richTree"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/treetable/trash-node.png"
													width="16" height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="convertToNode" rendered="#{node.leaf}"
											value="Convert to branch"
											action="#{identifyRequirements.convertToNode(node)}"
											onclick="changed();" reRender="richTree"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/treetable/add-node.png"
													width="16" height="16" />
											</f:facet>
	
										</rich:menuItem>
										<rich:menuItem id="convertToLeaf" value="Convert to leaf"
											rendered="#{not node.leaf and node.parent != null}"
											action="#{identifyRequirements.convertToLeaf(node)}"
											onclick="if(!confirm('Are you sure you want to convert this node and remove all of its children?'))return false;changed();"
											reRender="richTree"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/treetable/add-leaf.png"
													width="16" height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="saveLeaf" value="Save this leaf"
											action="#{identifyRequirements.selectFragmentForSaving(node)}"
											oncomplete="Richfaces.showModalPanel('savePanel',{top:'100px'});"
											ajaxSingle="true" reRender="savePanel" rendered="#{node.leaf}"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/save.png" width="16"
													height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="saveBranch" value="Save this branch"
											action="#{identifyRequirements.selectFragmentForSaving(node)}"
											oncomplete="Richfaces.showModalPanel('savePanel',{top:'100px'});"
											ajaxSingle="true" reRender="savePanel"
											rendered="#{node.parent!=null and !node.leaf}"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/save.png" width="16"
													height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="saveTree" value="Save this tree"
											action="#{identifyRequirements.selectTreeForSaving(node)}"
											oncomplete="Richfaces.showModalPanel('saveTreePanel',{top:'100px'});"
											ajaxSingle="true" reRender="saveTreePanel"
											rendered="#{node.parent==null}"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/save.png" width="16"
													height="16" />
											</f:facet>
										</rich:menuItem>
										<rich:menuItem id="insertNode2" rendered="#{!node.leaf}"
											value="Insert fragment at this node"
											action="#{identifyRequirements.selectInsertionTarget(node)}"
											ajaxSingle="true" reRender="insertPanel"
											oncomplete="Richfaces.showModalPanel('insertPanel',{top:'100px'});"
											eventsQueue="ajaxQ">
											<f:facet name="icon">
												<h:graphicImage value="../img/load.png" width="16"
													height="16" />
											</f:facet>
										</rich:menuItem>
									</rich:dropDownMenu>
								<s:div styleClass="mappingDiv" rendered="#{node.leaf and not doEditNodeComments.bool}">
								<a4j:commandLink
									action="#{measurablePropertyMapper.editLeaf(node)}"
									reRender="propertyMappingEditor"
									oncomplete="Richfaces.showModalPanel('propertyMappingEditor',{top:'100px'});"
									eventsQueue="ajaxQ">
									<h:graphicImage id="showMapping"
										value="../img/icons/big/paperclip#{(not node.mapped)?'':'-green'}.png"
										title="Edit measurement info: #{(node.mapped ? (node.measurementInfo.uri):'')}"
										width="22" height="22" />
								</a4j:commandLink>
								</s:div>
								</h:panelGrid>
							</s:div>
							<s:div id="scaleEdits" rendered="#{not doEditNodeComments.bool}"
								styleClass="treetable_cell">
								<div class="treetable_cell" style="width: 50px; text-align: center">
									
								<h:selectBooleanCheckbox id="single" rendered="#{node.leaf}" onchange="changed();"
									value="#{node.single}" />
								</div>

								<s:div rendered="#{node.leaf}" styleClass="treetable_cell"
									style="width: 135px;">
									<h:selectOneMenu style="font-size:smaller;" valueChangeListener="#{node.touch}"
										value="#{node.scaleByClassName}" id="idScaleList">
										<f:selectItem itemValue="" />
										<f:selectItems value="#{verysimpleScaleList.scaleList}" />
										<a4j:support onsubmit="changed();" action="#{node.touch}"
											event="onchange" reRender="scaleEdits" eventsQueue="ajaxQ"/>
									</h:selectOneMenu>
								</s:div>

								<div class="treetable_cell" style="width: 200px;"><s:decorate
									id="restrictionDecorate">
									<div class="inputDecorate"><span
										class="#{invalid?'errors':''}"> <s:validateAll>
										<h:inputText id="restriction" 
											value="#{node.scale.restriction}" style="font-size:smaller;" 
											disabled="#{node.leaf and (node.scale.immutableRestriction)}"
											rendered="#{node.leaf and (node.scale != null) and node.scale.restricted}"
											converterMessage="Restriction not valid for scale #{node.scale.displayName}.">
											<f:validateLength maximum="255" />
											<a4j:support onsubmit="changed();" event="onchange"
												action="#{node.scale.touch}" eventsQueue="ajaxQ"/>
										</h:inputText>
									</s:validateAll></span> <s:message styleClass="errorMessage" /></div>
								</s:decorate> <h:inputText disabled="true" value=""
									rendered="#{node.leaf and (node.scale != null) and (not node.scale.restricted)}" />
								</div>
								<div class="treetable_cell" style="width: 90px;"><s:decorate
									id="unitDecorate">
									<div class="inputDecorate"><span
										class="#{invalid?'errors':''}"> <s:validateAll>

										<h:inputText value="#{node.scale.unit}" id="unit" style="font-size:smaller;" 
											rendered="#{node.leaf and (node.scale != null)}">
											<f:validateLength maximum="255" />
											<a4j:support onsubmit="changed();" event="onchange"
												action="#{node.scale.touch}" eventsQueue="ajaxQ"/>
										</h:inputText>
									</s:validateAll></span> <s:message styleClass="errorMessage" /></div>
								</s:decorate> <h:inputText disabled="true" value="x"
									rendered="#{node.leaf and (node.scale == null)}" /></div>

							
							</s:div>														
							<s:div rendered="#{doEditNodeComments.bool}" style="margin-right:50px;padding-left:150px;">
								<h:inputTextarea id="description" rows="2"
									value="#{node.description}" style="width: 350px;">
									<f:validateLength maximum="32672" />
								</h:inputTextarea>
							</s:div></div>
						</rich:treeNode>
					</rich:recursiveTreeNodesAdaptor>
				</rich:tree></div>
			</s:div></fieldset>


			<fieldset id="description" class="size-full"><legend>
			<ui:include src="../legend_nav.xhtml"></ui:include> <h:outputText
				value="Descriptive Information" /> </legend> <p:inputTextArea
				labelText="Description" id="identifyRequirementsDescription"
				input="#{selectedPlan.requirementsDefinition.description}"
				bean="#{selectedPlan.requirementsDefinition}"
				actionMethodName="touch" /></fieldset>
			<p:buttons bean="#{identifyRequirements}" />
		</a4j:form></div>
		<a href="uploads" />
		<fieldset id="uploads" class="size-full"><legend>
		<ui:include src="../legend_nav.xhtml">
		</ui:include> <h:outputText value="Uploads" /> </legend> <h:form id="requirementsUploads"
			enctype="multipart/form-data">
			<h:dataTable value="#{requirementsUploads}" var="row"
				rendered="#{requirementsUploads != null and requirementsUploads.rowCount>0}"
				columnClasses="margin-top-big margin-bottom-small margin-left-big margin-right-big size-xxl noborder, margin-top-big margin-bottom-big margin-left-small margin-right-small noborder,  align-vertical-center margin-left-big margin-right-big border size-xs"
				headerClass="margin-left-big margin-right-big border nowrap"
				rowClasses="border">
				<h:column>
					<f:facet name="header">
						<h:outputText value="Fullname" />
					</f:facet>
					<h:outputText value="#{row.fullname}" />
				</h:column>
				<h:column>
					<f:facet name="header">
						<h:outputText value="Action" />
					</f:facet>
					<h:commandButton id="removeFile" value="Remove"
						action="#{identifyRequirements.removeAttachedFile}" />
				</h:column>
				<h:column>
					<h:commandButton id="downloadFile" value="Download"
						action="#{identifyRequirements.downloadAttachment}" />
				</h:column>
			</h:dataTable>
			<p>Please attach extended documentation (about the requirements definition process, 
			about suggested measurements, or about reasons for certain requirements) here:
			</p>
			<p:fileUpload data="#{fileToAttach.data.data}"
				fileName="#{fileToAttach.fullname}"
				contentType="#{fileToAttach.contentType}" id="attachFiles"
				bean="#{identifyRequirements}" actionMethodName="attachFile"
				text="Attach documentation file" />
		</h:form>
		<hr />
		<p>You can replace the current objective tree with a tree
		specified in Freemind format by uploading it here. Bear in mind that
		this replaces your current tree! <br />
		<a target="_blank" href="/plato/help/upload.html">How can I
		specify trees in XML?</a></p>
		<h:form id="uploadform" enctype="multipart/form-data">
			<h:outputText value="Does the tree have Units?" />
			<h:selectBooleanCheckbox id="hasUnitsCheckbox"
				value="#{hasUnits.bool}" />
			<p:fileUpload data="#{identifyRequirements.file}"
				fileName="#{fileName}" contentType="#{contentType}"
				id="freemindUpload" bean="#{identifyRequirements}"
				actionMethodName="upload" text="Upload new requirements tree" />
			<hr />
			<p>If you want to continue working on the tree in Freemind, you
			can download the current objective tree as mindmap file for Freemind.
			Please save the tree before downloading it!</p>
			<h:commandButton id="downloadFreemind"
				value="Download the tree as a mindmap"
				action="#{identifyRequirements.downloadTree}" />
		</h:form></fieldset>

	</ui:define>
</ui:composition>