<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:t="http://myfaces.apache.org/tomahawk"
    xmlns:c="http://java.sun.com/jstl/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich">
<body>
<ui:composition template="/WEB-INF/templates/main_template.xhtml">
			
	<ui:define name="title">
        #{res.title} - #{ExperimentBean.ename}: #{res['exp_stage5.pageTitle']}
  </ui:define>

	<ui:define name="header">
		<ui:include src="/WEB-INF/templates/header.xhtml">
			<ui:param name="page" value="new_exp" />
		</ui:include>
	</ui:define>

	<ui:define name="content" rendered="#{ExperimentBean != null}">
		<div id="mainwrapper">
		<div id="maincol">
		<div class="innertubemain">

<h:form>    
    <ui:include src="/WEB-INF/templates/exp_page_bands.xhtml">
       <ui:param name="ExperimentPhase" value="5" />
       <ui:param name="PlaceBandAsHeader" value="true" />
    </ui:include>

<h:panelGroup class="expRunStatusPanel">
    <a4j:outputPanel id="progressPanel">
      <h:panelGroup styleClass="#{NewExp_Controller.experimentExecutable.executionRunning ? 'expRunStatusRun' : 'expRunStatusWait' }">
      <h:outputText value="Executed #{NewExp_Controller.experimentExecutable.numBatchExecutionRecords} times." 
          rendered="#{not NewExp_Controller.experimentExecutable.executionRunning}" styleClass="statusMessage"/>
      <rich:progressBar value="#{NewExp_Controller.executeExperimentProgress}"
          interval="1000" label="#{NewExp_Controller.executeExperimentProgress} %"
          enabled="#{NewExp_Controller.experimentExecutable.executionRunning}" minValue="-1" maxValue="100" styleClass="expRunStatusRun"
          reRenderAfterComplete="progressPanel,runExperimentForm" reRender="runExperimentForm,progressPanel">
      </rich:progressBar>
      </h:panelGroup>
    </a4j:outputPanel>
    </h:panelGroup>
    	
<a4j:outputPanel id="runExperimentForm">
    <h:panelGroup rendered="#{not NewExp_Controller.experimentExecutable.executionCompleted}">
    
                   <h:panelGroup rendered="#{((not NewExp_Controller.experimentExecutable.executionRunning) and (not NewExp_Controller.experimentExecutable.executionCompleted))}">
                        <p>Your experiment has been setup and approved successfully - you may now <b>run the experiment</b>: </p>
                       <p>
                       
					   </p>    
					    
                <h:commandButton id="executeExperimentButton" value="#{res['exp_stage5.button.run']}" 
                action="#{NewExp_Controller.executeExperiment}" disabled="#{(NewExp_Controller.experimentExecutable.executionRunning) or (ExperimentBean.experiment.currentPhaseIndex gt 5)}"
                style="font-size: larger; font-weight: bold; color: green;">
                </h:commandButton>                        
                    </h:panelGroup>
                   <h:panelGroup rendered="#{((not NewExp_Controller.experimentExecutable.executionRunning) and (not NewExp_Controller.experimentExecutable.executionCompleted))}">
                        <p><br/><br/>If you have made an error, and wish to make further alterations before running your experiment, you can go back to the editing stage:</p>
                        <h:commandButton value="#{res['button.edit']}"
                        action="#{NewExp_Controller.unsubmitAndEdit}"/>
                    </h:panelGroup>
    </h:panelGroup>

     <h:panelGroup rendered="#{! NewExp_Controller.experimentExecutable.executionRunning}" >
         <h:commandButton action="#{NewExp_Controller.executeExperimentStart}"
                      value="Re-run this experiment to collect more data." 
                      rendered="#{NewExp_Controller.experimentExecutable.numBatchExecutionRecords > 0 }" disabled="#{ExperimentBean.experiment.currentPhaseIndex gt 5}"/>
        <h:commandButton value="Refresh This Page"
                            action="goToStage5" />
     </h:panelGroup>
     <h:panelGroup rendered="#{NewExp_Controller.experimentExecutable.executionRunning}" >
                        <p>
                            Your experiment is currently being executed. Depending on the intensity of your experiment this may take some time.
                            <br/>
                            <h:commandButton value="Refresh This Page"
                            action="goToStage5" />
                        </p>
     </h:panelGroup>
     
</a4j:outputPanel>

<!-- ***************************  -->

<a4j:outputPanel id="executedResults">
<h:panelGroup rendered="#{ NewExp_Controller.experimentExecutable.numBatchExecutionRecords > 0 }">
<!-- START Automated Results -->
<a4j:region id="regionAutoMResults" renderRegionOnly="true">
<rich:simpleTogglePanel label="#{res['exp_stage5.automaticResults']}" opened="true" switchType="ajax">
	<p>These are the results the Testbed has automatically measured and recorded for your experiment.</p>

    <rich:tabPanel width="100%" selectedTab="OverallResultTab" rendered="#{NewExp_Controller.experimentExecutable.numBatchExecutionRecords > 0 }" switchType="ajax">
        <rich:tab label="Overall Results" name="OverallResultTab">
     

        <c:if test="#{ExperimentBean.etype == 'identify'}">
        
        <ui:include src="/WEB-INF/templates/exp-types/stage5_identify_result.xhtml">
           <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
        </ui:include>
          
        </c:if>

                
        <c:if test="#{ExperimentBean.etype == 'migrate'}">
        
        <ui:include src="/WEB-INF/templates/exp-types/stage5_migrate_result.xhtml">
           <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
        </ui:include>
        
        </c:if>

     
        <c:if test="#{ExperimentBean.etype == 'emulate'}">
        
        <ui:include src="/WEB-INF/templates/exp-types/stage5_createview_result.xhtml">
           <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
        </ui:include>
        
        </c:if>

     
        <p>
        The experiment has been executed #{NewExp_Controller.experimentExecutable.numBatchExecutionRecords} times on #{NewExp_Controller.experimentExecutable.numberOfInputs} digital objects.
        </p>
        
        </rich:tab>

        
        <rich:tab label="Service Statistics">
            <p>
            Runtime statistics here. e.g. execution time of each service/stage, versus (exec, type, size).
            </p>
            <p>
            <img src="#{ExperimentBean.servicePlotImageUrl}" />
            </p>
        </rich:tab>
        
        <rich:tab label="Raw Execution Log" name="ExeLogTab">
            
<h:panelGrid columns="2" styleClass="expDesignerPanel" columnClasses="doListColumn,expDesignColumn">
            <rich:panel styleClass="expExecLogPanel">
                
     <rich:dataTable id="batchExecRecordsTable" value="#{NewExp_Controller.experimentExecutable.batchExecutionRecords}" 
         var="batch" styleClass="tbTable" reRender="exelog_ds" rows="10" rowKeyVar="counter">
      <rich:column sortBy="#{batch.endDate}" sortOrder="DESCENDING">
        <f:facet name="header">Execution Date</f:facet>
        <a4j:commandLink reRender="execResultsDetailPanel,batchExecRecordsTable">
          	<f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectBatchExecutionRecordActionListener"/>
        	<h:outputText value="#{batch.startDate.time}" styleClass="#{ ( ExperimentBean.selectedBatchExecutionRecord.startDate.time eq batch.startDate.time ) ? 'isSelected' : 'isNotSelected'}" >
          		<f:convertDateTime type="both" dateStyle="short"/>
        	</h:outputText>
        </a4j:commandLink>
      </rich:column>
      <rich:column>
        <f:facet name="header">Execution Success</f:facet>
        <a4j:commandLink reRender="execResultsDetailPanel,batchExecRecordsTable">
          <f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectBatchExecutionRecordActionListener"/>
          <h:outputText value="#{batch.batchRunSucceeded}"/>
        </a4j:commandLink>
      </rich:column>
      
      <f:facet name="footer">
         <rich:datascroller id="exelog_ds" renderIfSinglePage="false"></rich:datascroller>
      </f:facet>
      
    </rich:dataTable>
    
    </rich:panel>
    <rich:panel id="execResultsDetailPanel" styleClass="expMeasurementPanel">
                <f:facet name="header">
                Execution Results In Detail
                </f:facet>
                
         <h:panelGroup rendered="#{ExperimentBean.selectedBatchExecutionRecord != null}">
         
         <a4j:repeat value="#{ExperimentBean.selectedBatchExecutionRecord.runs}" var="run" rowKeyVar="count">
         <rich:simpleTogglePanel label="data entry: #{count+1} - #{run.digitalObjectSource}" opened="#{count>0 ? false : true}" switchType="client">

         <a4j:repeat value="#{run.stages}" var="stage">
        
          <rich:dataTable value="#{stage.measuredObservables}" var="m" styleClass="tbTable">
                <f:facet name="header">#{stage.stage}</f:facet>
            <rich:column>
              <f:facet name="header">Measurement</f:facet>
              
                <!--  Full property definitions is available:  -->
                <h:panelGroup rendered="#{m.name != null}">
                  <t:graphicImage value="/graphics/help.gif" style="float: right; padding: 1px 5px;"/>
                  <h:outputText value="#{m.name}"/>
                </h:panelGroup>
                <rich:toolTip showDelay="500" rendered="#{m.name != null}">
                  <h:outputText value="#{m.description}"/>
                  <h:panelGroup rendered="#{m.identifier != null}">
                    <br/><i><h:outputText value="(URI: #{m.identifier})"/></i>
                  </h:panelGroup>
                </rich:toolTip>
                
                <!-- Otherwise, just show the property ID: -->
                <h:panelGroup rendered="#{m.name == null}">
                  <i><h:outputText value="#{m.identifier}"/></i>
                </h:panelGroup>
                
            </rich:column>
            <rich:column>
              <f:facet name="header">Value</f:facet>
              <h:outputText value="#{m.value}"/><h:outputText value=" [#{m.unit}]" rendered="#{m.unitDefined}"/>
            </rich:column>
          </rich:dataTable>
          
         </a4j:repeat>
         
         </rich:simpleTogglePanel>
         <br/>
         </a4j:repeat>
         
         </h:panelGroup>
         
         <h:panelGroup rendered="#{ExperimentBean.selectedBatchExecutionRecord == null}">
         <p>Please select a batch execution time (on the left) to see the batch results.</p>
         </h:panelGroup>
                
    </rich:panel>
    
    </h:panelGrid>

    <p>         
        <h:outputLink value="/testbed/reader/results.jsp">
          <f:param name="eid" value="#{ExperimentBean.experiment.entityID}"/>
          <h:outputText value="Click here to download data from all runs, in CVS format..."/>
        </h:outputLink>
    </p>

        </rich:tab>
        
        <rich:tab label="Server Specification">
       	 <ui:include src="/WEB-INF/templates/server_spec.xhtml" />
        </rich:tab>
        
     </rich:tabPanel>

</rich:simpleTogglePanel>

</a4j:region>
<!-- END Automated Results -->

<!-- START Manual Results -->
<a4j:region id="regionManualMResults" renderRegionOnly="true">
<rich:simpleTogglePanel label="#{res['exp_stage5.manualResults']}" opened="true" switchType="ajax">
	<!-- only render if no experiment re-execution is currently taking place -->
	<h:panelGroup rendered="#{! NewExp_Controller.experimentExecutable.executionRunning}">
		<p>Please fill in the properties you have selected to measure manually for this experiment.</p>
		<h:outputText value="No manually measured properties have been selected for this experiment" rendered="#{empty NewExp_Controller.manualObservables}"/>
		
		<rich:tabPanel switchType="ajax" rendered="#{not empty NewExp_Controller.manualObservables}">
	        <rich:tab label="Overview of Entered Data">
	        	TODO enter a short description on how data is entered
	        	<!-- TODO create some custom styleclasses for this screen -->

	        	<h:panelGrid columns="3" styleClass="expDesignerPanel">
		        	<rich:dataTable value="#{ExperimentBean.experimentInputDataValues}" var="inputDigoItem" rows="10" 
			        reRender="propmanual_ds" styleClass="tbTable"
			        id="inputDigObjectRefTable" rowKeyVar="count">
			            <rich:column>
			                <f:facet name="header">
			                    <h:outputText value="Input DigitalObjects Record"/>
			                </f:facet>
			                <a4j:commandLink actionListener="#{ExperimentBean.processDigitalObjectRefInStep5OverviewTable}" ajaxSingle="true" eventsQueue="foo" ignoreDupResponses="true" reRender="infopanel,inputDigObjectRefTable,manualMeasurementsStep5Table">
			                	<h:outputText id="recoutputtext" value="record: #{count+1}: id: #{inputDigoItem.digitalObjectName}" styleClass="#{ ( inputDigoItem.digitalObject eq ExperimentBean.selDigitalObjectRefPageInStep5OverviewTable ) ? 'isSelected' : 'isNotSelected'}" /> 
			            		<a4j:actionparam name="selInputDataRef" value="#{inputDigoItem.digitalObject}"/>
			            	</a4j:commandLink>
			            </rich:column>
				            <f:facet name="footer">
			                <rich:datascroller for="inputDigObjectRefTable" id="propmanual_ds" renderIfSinglePage="false"></rich:datascroller>
			            </f:facet>
			        </rich:dataTable>
			        
			        <rich:dataTable id="manualMeasurementsStep5Table" value="#{ExperimentBean.stages}" var="tableVar" rows="10" styleClass="tbTable"
			        onRowMouseOver="this.style.backgroundColor='F8F8F8'"
	                onRowMouseOut="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'"
	                rendered="#{ExperimentBean.allRunDatesSize gt 0}">
						<f:facet name="header">
							<rich:columnGroup>
								<rich:column colspan="2">
									<h:outputText value="Property Information" />
								</rich:column>
								<rich:column colspan="#{ExperimentBean.allRunDatesSize}">
									<h:outputText value="Experiment Execution Measurements Runs" />
								</rich:column>	
							</rich:columnGroup>
						</f:facet>
						<!-- display the stage name e.g. migrate -->
						<rich:column id="colstagename" colspan="#{2+ExperimentBean.allRunDatesSize}" breakBefore="true">
							<h:outputText value="#{tableVar.name}"/>
						</rich:column>
						
						<!--  add the subtable containing the execution information per property -->
						<rich:subTable id="subtable" value="#{ExperimentBean.allManualExecutionRecords[tableVar.name]}" var="subVar"
						onRowMouseOver="this.style.backgroundColor='#F1F1F1'"
						onRowMouseOut="this.style.backgroundColor='#FFFFFF'"
						rendered="#{not empty ExperimentBean.allManualExecutionRecords}">
						
							<!-- start outputing the data: property name + unit -->
							<rich:column id="colstagename" breakBefore="true">
								<f:facet name="header">
									<h:outputText value="name"/>
								</f:facet>
								<h:outputText value="#{subVar.measurementInfo.name}" rendered="#{not empty subVar.measurementInfo.name}"/>
								<h:outputText value="#{subVar.measurementPropertyID}" rendered="#{empty subVar.measurementInfo.name}"/>
								<rich:toolTip style="width:500px;" showDelay="500" rendered="#{not empty subVar.measurementInfo.name}">
									<h:outputText value="#{subVar.measurementInfo.description}"/>
					                <h:panelGroup rendered="#{subVar.measurementPropertyID != null}">
					                  <br/><i><h:outputText value="(URI: #{subVar.measurementPropertyID})"/></i>
					                </h:panelGroup>
								</rich:toolTip>
							</rich:column>	
							<rich:column id="colstageunit">
								<f:facet name="header">
									<h:outputText value="unit"/>
								</f:facet>
								<h:outputText value="#{subVar.measurementInfo.unit}"/>
							</rich:column>		
							
							<rich:columns value="#{ExperimentBean.allRunDates}" index="index" var="rundatesColVar">
				              <f:facet name="header">
									<h:outputText value="#{rundatesColVar.time}">
	          							<f:convertDateTime type="both" dateStyle="short"/>
	        						</h:outputText>
								</f:facet>
				              <!-- inplaceInput elements with ajax support if current phase is 5 -->
				              <h:panelGroup rendered="#{ExperimentBean.experiment.currentPhaseIndex lt 6}">
				              	<rich:inplaceInput layout="block" selectOnEdit="true" editClass="onclick" defaultLabel="click to enter" 
				              	value="#{subVar.allResults[rundatesColVar.timeInMillis].recordValue}" valueChangeListener="#{NewExp_Controller.processManualDataEntryChange}">
				              		<a4j:support event="onviewactivated" eventsQueue="foo" ignoreDupResponses="true" ajaxSingle="true" reRender="infopanel,inputDigObjectRefTable,manualMeasurementsStep5Table"> 
				              			<a4j:actionparam name="propertyID" value="#{subVar.measurementPropertyID}"/>
				              			<a4j:actionparam name="stageName" value="#{tableVar.name}"/>
				              			<a4j:actionparam name="runDateMillis" value="#{rundatesColVar.timeInMillis}"/>
				              			<a4j:actionparam name="inputDigoRef" value="#{subVar.inputDigoRef}"/>
				              		</a4j:support>
				              		<rich:contextMenu event="oncontextmenu" attached="true" submitMode="ajax">	         
						               	<rich:menuItem actionListener="#{NewExp_Controller.processCopyManualPropertyResultForAllExecutions}" eventsQueue="foo" ignoreDupResponses="true" ajaxSingle="true" reRender="infopanel,inputDigObjectRefTable,manualMeasurementsStep5Table">
											<b>copy value</b> for all executions
											<a4j:actionparam name="propertyID" value="#{subVar.measurementPropertyID}"/>
					              			<a4j:actionparam name="stageName" value="#{tableVar.name}"/>
					              			<a4j:actionparam name="value" value="#{subVar.allResults[rundatesColVar.timeInMillis].recordValue}"/>
					              			<a4j:actionparam name="inputDigoRef" value="#{subVar.inputDigoRef}"/>
										</rich:menuItem>
				              		</rich:contextMenu>
				              	</rich:inplaceInput>
				              </h:panelGroup>
				              <!-- read only outputText elements if stage currentPhase is 6 -->
				              <h:panelGroup rendered="#{!(ExperimentBean.experiment.currentPhaseIndex lt 6)}">
				              	<h:outputText value="#{subVar.allResults[rundatesColVar.timeInMillis].recordValue}" rendered="#{(subVar.allResults!=null) and (subVar.allResults[rundatesColVar.timeInMillis].recordValue !=null)}"/>
				              	<h:outputText value="no result" rendered="#{!((subVar.allResults!=null) and (subVar.allResults[rundatesColVar.timeInMillis].recordValue !=null))}"/>	
				              </h:panelGroup>
							</rich:columns>				
						</rich:subTable>
					</rich:dataTable>
	
	                <rich:panel id="infopanel">
	                	<f:facet name="header">
	                		Status Information
	                	</f:facet>
	                	You have currently entered data for the following records<br/>
						<br/>
					</rich:panel>
				</h:panelGrid>
			</rich:tab>
			<rich:tab label="Data Input Wizard">
				TBC
	        </rich:tab>
			<rich:tab label="Compare Results">
				property statistics, charts, and comparison. TBC
	        </rich:tab>
		 </rich:tabPanel>
	</h:panelGroup>
	<h:outputText value="The experiment is currently being executed - please wait until execution has terminated" rendered="#{NewExp_Controller.experimentExecutable.executionRunning}"/>
</rich:simpleTogglePanel>
</a4j:region>

</h:panelGroup>
</a4j:outputPanel>

<!-- ******************  -->

    <ui:include src="/WEB-INF/templates/exp_page_bands.xhtml">
       <ui:param name="ExperimentPhase" value="5" />
       <ui:param name="PlaceBandAsHeader" value="false" />
    </ui:include>

<!-- ******************  -->

        <rich:simpleTogglePanel label="Hacky Development And Debug Options" opened="false" rendered="#{UserBean.admin}">
         <p>
       #{NewExp_Controller.executeExperimentIsRunning}, and #{TestbedBatchProcessor.daemon.secs}
       <h:commandButton value="HACK! Click to abort runningness." action="#{NewExp_Controller.commandResetAfterFailure}" />
         </p>

    <h:panelGroup rendered="#{((not NewExp_Controller.experimentExecutable.executionRunning) and (NewExp_Controller.experimentExecutable.executionCompleted))}">
                <p>Experiment execution took place with the following details:</p>
                <div class="box">
                <!--  display some statistics -->
                <h3 class="box">#{res['exp_stage5.statistics']}</h3>
                <p class="box">
                    <b>#{res['exp_stage5.started']} </b>#{NewExp_Controller.experimentExecutable.executionStartDate.time}<br />
                    <b>#{res['exp_stage5.ended']} </b>#{NewExp_Controller.experimentExecutable.executionEndDate.time}<br />
                    <b>#{res['exp_stage5.nrOfInput']} </b>#{ExperimentBean.numberOfOutput}<br />
                    <b>#{res['exp_stage5.nrOfOutput']} </b>#{ExperimentBean.numberOfInputFiles}<br />
                    <b>#{res['exp_stage5.success']} </b>#{NewExp_Controller.experimentExecutable.executionSuccess}<br />
                </p>
                </div>
    </h:panelGroup>
        
        </rich:simpleTogglePanel>

<!-- ******************  -->

</h:form>

        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
            
    <ui:include src="/WEB-INF/templates/comment_template.xhtml">
       <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
       <ui:param name="ExperimentPhase" value="5" />
    </ui:include>
    
		</div>
		</div>
		</div>


		<div id="leftcol">

        <!-- Include the standard experiment builder sidebar. -->
        <ui:include src="/WEB-INF/templates/exp_sidebar.xhtml">
           <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
           <ui:param name="ExperimentPhase" value="5" />
        </ui:include>

		</div>

	</ui:define>
	<ui:define name="footer">
		<ui:include src="/WEB-INF/templates/footer.xhtml" />
	</ui:define>
</ui:composition>

</body>
</html>
