<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://java.sun.com/jsf/html"
    xmlns:f="http://java.sun.com/jsf/core"
    xmlns:t="http://myfaces.apache.org/tomahawk"
    xmlns:c="http://java.sun.com/jstl/core"
    xmlns:ui="http://java.sun.com/jsf/facelets"
    xmlns:a4j="http://richfaces.org/a4j"
    xmlns:rich="http://richfaces.org/rich">
<body>
<ui:composition template="/WEB-INF/templates/main_template.xhtml">
	<ui:define name="title">
        #{res.title} - #{ExperimentBean.ename}: #{res['exp_stage5.pageTitle']}
  </ui:define>

	<ui:define name="header">
		<ui:include src="/WEB-INF/templates/header.xhtml">
			<ui:param name="page" value="new_exp" />
		</ui:include>
	</ui:define>

	<ui:define name="content" rendered="#{ExperimentBean != null}">
		<div id="mainwrapper">
		<div id="maincol">
		<div class="innertubemain">

<h:form>    
    <ui:include src="/WEB-INF/templates/exp_page_bands.xhtml">
       <ui:param name="ExperimentPhase" value="5" />
       <ui:param name="PlaceBandAsHeader" value="true" />
    </ui:include>
      
    <a4j:outputPanel id="progressPanel">
                <!-- #{NewExp_Controller.executeExperimentIsRunning} -->
            <rich:progressBar value="#{NewExp_Controller.executeExperimentProgress}"
                interval="500" label="#{NewExp_Controller.executeExperimentProgress} %"
                enabled="true" minValue="0" maxValue="100"
                reRenderAfterComplete="progressPanel,runExperimentForm,executedResults" reRender="runExperimentForm,executedResults">
                <f:facet name="initial"> 
                    <h:outputText value="Process doesn't started yet" />
                    <a4j:commandButton action="#{NewExp_Controller.executeExperimentStart}"
                        value="Run Experiment" reRender="progressPanel"
                        rendered="true" />
                </f:facet>
                <f:facet name="complete">
                    <h:outputText value="Re-run Experiment" />
                    <a4j:commandButton action="#{NewExp_Controller.executeExperimentStart}"
                        value="Restart Process" reRender="progressPanel"
                        rendered="true" />
                </f:facet>
        
            </rich:progressBar>
    </a4j:outputPanel>
        
<a4j:outputPanel id="runExperimentForm">
    <h:panelGroup rendered="#{ExperimentBean.currentStage==5}">
                   <h:panelGroup rendered="#{((not NewExp_Controller.experimentExecutable.executionRunning) and (not NewExp_Controller.experimentExecutable.executionCompleted))}">
                        <p>Your experiment has been setup and approved successfully - you may now <b>run the experiment</b>: </p>
                <h:commandButton id="executeExperimentButton" value="#{res['exp_stage5.button.run']}" 
                action="#{NewExp_Controller.executeExperiment}" disabled="#{NewExp_Controller.experimentExecutable.executionRunning}">
                </h:commandButton>                        
                    </h:panelGroup>
                   <h:panelGroup rendered="#{((not NewExp_Controller.experimentExecutable.executionRunning) and (not NewExp_Controller.experimentExecutable.executionCompleted))}">
                        <p><br/><br/>If you have made an error, and wish to make further alterations before running your experiment, you can go back to the editing stage:</p>
                        <h:commandButton value="#{res['button.edit']}"
                        action="#{NewExp_Controller.unsubmitAndEdit}"/>
                    </h:panelGroup>
                    <h:panelGroup rendered="#{NewExp_Controller.experimentExecutable.executionRunning}" >
                        <p>
                            Your experiment is currently being executed. Depending on the intensity of your experiment this may take some time.
                            <br/>
                            <h:commandButton value="Refresh"
                            action="goToStage5" />
                        </p>
                   </h:panelGroup>
    </h:panelGroup>

</a4j:outputPanel>


<a4j:outputPanel id="executedResults" rendered="#{NewExp_Controller.experimentExecutable.numExecutionRecords > 0 }">

    <h2 class="main">Results</h2>

    <rich:tabPanel width="100%">
        <rich:tab label="Raw Experiment Execution Log">
            
<h:panelGrid columns="2" styleClass="expDesignerPanel" columnClasses="expDesignColumn">
            <rich:panel styleClass="expExecLogPanel">
                <f:facet name="header">Execution Log</f:facet>
                
     <rich:dataTable value="#{NewExp_Controller.experimentExecutable.executionRecords}" 
         var="erec" styleClass="tbTable" reRender="prop_ds" rows="10">
      <rich:column sortBy="#{erec.digitalObjectSource}">
        <f:facet name="header">Digital Object</f:facet>
        <h:commandLink>
          <f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectExecutionRecordActionListener"/>
          <h:outputText value="#{erec.digitalObjectSource}"/>
        </h:commandLink>
      </rich:column>
      <rich:column sortBy="#{erec.date}" sortOrder="DESCENDING">
        <f:facet name="header">Execution Date</f:facet>
        <h:commandLink>
          <f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectExecutionRecordActionListener"/>
        <h:outputText value="#{erec.date.time}">
          <f:convertDateTime type="both" dateStyle="short"/>
        </h:outputText>
        </h:commandLink>
      </rich:column>
      <rich:column>
        <f:facet name="header">Execution Success</f:facet>
        <h:commandLink>
          <f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectExecutionRecordActionListener"/>
        [To Add Success State]
        </h:commandLink>
      </rich:column>
      
      <f:facet name="footer">
         <rich:datascroller id="exelog_ds"></rich:datascroller>
      </f:facet>
      
    </rich:dataTable>
    <p>
    The experiment has been executed #{NewExp_Controller.experimentExecutable.numExecutionRecords/NewExp_Controller.experimentExecutable.numberOfInputs} times on #{NewExp_Controller.experimentExecutable.numberOfInputs} digital objects, leading to #{NewExp_Controller.experimentExecutable.numExecutionRecords} sets of results.
    </p>
    
    </rich:panel>
    <rich:panel styleClass="expMeasurementPanel">
                <f:facet name="header">
                Execution Results In Detail
                </f:facet>
                
         <h:panelGroup rendered="#{ExperimentBean.selectedExecutionRecord != null}">

         <a4j:repeat value="#{ExperimentBean.selectedExecutionRecord.stages}" var="stage">
        
          <rich:dataTable value="#{stage.measurements}" var="m" styleClass="tbTable">
                <f:facet name="header">#{stage.stage}</f:facet>
            <rich:column>
            <f:facet name="header">Measurement</f:facet>
            <h:outputText value="#{m.name}"/>
            </rich:column>
            <rich:column>
            <f:facet name="header">Value</f:facet>
            <h:outputText value="#{m.value}"/><h:outputText value=" #{m.unit}" rendered="#{m.unit != null}"/>
            </rich:column>
          </rich:dataTable>
          
         </a4j:repeat>
         
         </h:panelGroup>
                
    </rich:panel>
    
    </h:panelGrid>

        </rich:tab>
        
        <rich:tab label="Service Statistics">
            Runtime statistics here. e.g. execution time of each service/stage, versus (exec, type, size).

        </rich:tab>
        
        <rich:tab label="Digital Object Properties">
            Comparisons of the measured digital object properties. Cross-comparisons, etc.

        </rich:tab>
        
        <rich:tab label="Result Comparison & Evaluation">
            Difference displays, comparator configuration, depending on experiment type.
        
        </rich:tab>
        
        <rich:tab label="Hacky Development And Debug Options">
         <p>
       #{NewExp_Controller.executeExperimentIsRunning}, and #{TestbedBatchProcessor.daemon.secs}
       <h:commandButton value="HACK! Click to abort runningness." action="#{NewExp_Controller.commandResetAfterFailure}" />
         </p>

    <h:panelGroup rendered="#{((not NewExp_Controller.experimentExecutable.executionRunning) and (NewExp_Controller.experimentExecutable.executionCompleted))}">
                <p>Experiment execution took place with the following details:</p>
                <div class="box">
                <!--  display some statistics -->
                <h3 class="box">#{res['exp_stage5.statistics']}</h3>
                <p class="box">
                    <b>#{res['exp_stage5.started']} </b>#{NewExp_Controller.experimentExecutable.executionStartDate.time}<br />
                    <b>#{res['exp_stage5.ended']} </b>#{NewExp_Controller.experimentExecutable.executionEndDate.time}<br />
                    <b>#{res['exp_stage5.nrOfInput']} </b>#{ExperimentBean.numberOfOutput}<br />
                    <b>#{res['exp_stage5.nrOfOutput']} </b>#{ExperimentBean.numberOfInputFiles}<br />
                    <b>#{res['exp_stage5.success']} </b>#{NewExp_Controller.experimentExecutable.executionSuccess}<br />
                </p>
                </div>
    </h:panelGroup>
        
        </rich:tab>
    </rich:tabPanel>

     
</a4j:outputPanel>
    
    <ui:include src="/WEB-INF/templates/exp_page_bands.xhtml">
       <ui:param name="ExperimentPhase" value="5" />
       <ui:param name="PlaceBandAsHeader" value="false" />
    </ui:include>

</h:form>
		<p>&#160;</p>
		<p>&#160;</p>

		<p>&#160;</p>
		<p>&#160;</p>
		<p>&#160;</p>
		<p>&#160;</p>
		<p>&#160;</p>
		<p>&#160;</p>
		<p>&#160;</p>
		<p>&#160;</p>



            
    <ui:include src="/WEB-INF/templates/comment_template.xhtml">
       <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
       <ui:param name="ExperimentPhase" value="5" />
    </ui:include>
    
		</div>
		</div>
		</div>


		<div id="leftcol">

        <!-- Include the standard experiment builder sidebar. -->
        <ui:include src="/WEB-INF/templates/exp_sidebar.xhtml">
           <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
           <ui:param name="ExperimentPhase" value="5" />
        </ui:include>

		</div>

	</ui:define>
	<ui:define name="footer">
		<ui:include src="/WEB-INF/templates/footer.xhtml" />
	</ui:define>
</ui:composition>

</body>
</html>