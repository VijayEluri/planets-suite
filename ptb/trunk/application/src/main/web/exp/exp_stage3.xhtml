<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
    xmlns:t="http://myfaces.apache.org/tomahawk"
    xmlns:c="http://java.sun.com/jstl/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich">
<body>
<ui:composition template="/WEB-INF/templates/main_template.xhtml">
	<ui:define name="title">
        #{res.title} - #{ExperimentBean.ename}: #{res['exp_stage3.pageTitle']}
  </ui:define>

	<ui:define name="header">
		<ui:include src="/WEB-INF/templates/header.xhtml">
			<ui:param name="page" value="new_exp" />
		</ui:include>
		<script type="text/javascript"
			src="${facesContext.externalContext.requestContextPath}/js/overlib/overlib.js"></script>
	</ui:define>

	<ui:define name="content" rendered="#{ExperimentBean != null}">
		<div id="mainwrapper">
			<div id="maincol">
				<div class="innertubemain">        
<a4j:form>

    <ui:include src="/WEB-INF/templates/exp_page_bands.xhtml">
       <ui:param name="ExperimentPhase" value="3" />
       <ui:param name="PlaceBandAsHeader" value="true" />
    </ui:include>

      <ui:include src="/WEB-INF/templates/global_error_box.xhtml"/>

<a4j:region id="regionAutoMProps" renderRegionOnly="true">
<rich:simpleTogglePanel label="#{res['exp_stage3.automaticProps']}" opened="true" switchType="ajax">
	<p>These are properties that the Testbed can automatically measure during your experiment.</p>
	
	<!-- the service backed properties -->
	<h:panelGrid columns="2" styleClass="expDesignerPanel" columnClasses="doListColumn,expDesignColumn">
	    <rich:panel styleClass="expExecLogPanel">
        <rich:dataTable value="#{NewExp_Controller.stages}" var="stage" styleClass="tbTable">
            <rich:column> 
                <f:facet name="header">
                    <h:outputText value="Experiment Stage"/>
                </f:facet>
                <h:commandLink>
          			<f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectStageActionListener"/>
                	<h:outputText value="#{stage.name}" styleClass="#{ ( ExperimentBean.selectedStage.name eq stage.name ) ? 'isSelected' : 'isNotSelected'}" />
                </h:commandLink>
            </rich:column>
        </rich:dataTable>
         
        <h:panelGroup rendered="#{ExperimentBean.selectedStage == null}">
          Select an experiment stage to view.
        </h:panelGroup>
        <h:panelGroup rendered="#{ExperimentBean.selectedStage != null}">
        <p>
        Stage: #{ExperimentBean.selectedStage.name}
        </p>
        <p>
        #{ExperimentBean.selectedStage.description}
        </p>
        </h:panelGroup>
        
    </rich:panel>
    <rich:panel styleClass="expMeasurementPanel">
        <rich:dataTable value="#{NewExp_Controller.observables}" var="prop" rows="10" 
        reRender="prop_ds" styleClass="tbTable" binding="#{NewExp_Controller.obsTable}"
        id="automMeasurmentTable">
        <!-- 
            <f:facet name="header">
                <h:outputText value="Observable Properties"/>
            </f:facet>
         -->
            
            <rich:column> 
                <f:facet name="header">
                    <h:outputText value="Measure"/>
                </f:facet>
                <h:selectBooleanCheckbox value="#{prop.selected}"  disabled="#{ExperimentBean.approved || true}" valueChangeListener="#{NewExp_Controller.handleObsSelectChangeListener}"/>
            </rich:column>
            
            <rich:column sortBy="#{prop.type}">
                <f:facet name="header">
                    <h:outputText value="Type"/>
                </f:facet>
                <h:outputText value="#{prop.type}"/> 
            </rich:column>
            
            <rich:column sortBy="#{prop.name}" sortOrder="DESCENDING">
                <f:facet name="header">
                    <h:outputText value="Name"/>
                </f:facet>
                <t:graphicImage value="/graphics/help.gif" style="float: right; padding: 1px 5px;"/>
                <h:outputText value="#{prop.name}"/>
                <rich:toolTip showDelay="500">
                  <h:outputText value="#{prop.description}"/>
                  <h:panelGroup rendered="#{prop.identifier != null}">
                    <br/><i><h:outputText value="(URI: #{prop.identifier})"/></i>
                  </h:panelGroup>
                </rich:toolTip>
            </rich:column>
            
            <rich:column sortBy="#{prop.unit}">
                <f:facet name="header">
                    <h:outputText value="Unit"/>
                </f:facet>
                <h:outputText value="#{prop.unit}"/> 
            </rich:column>
            
            <f:facet name="footer">
                <rich:datascroller for="automMeasurmentTable" id="prop_ds" renderIfSinglePage="false"></rich:datascroller>
            </f:facet>
        </rich:dataTable>
        
    </rich:panel>
</h:panelGrid>

</rich:simpleTogglePanel>
</a4j:region>

<!-- the manually measured properties -->
<a4j:region id="regionManualPropsTogglePanel" renderRegionOnly="true">
<rich:simpleTogglePanel id="manualprops" label="#{res['exp_stage3.ontologyProps']}" opened="true" switchType="client">  
    <p>These are the selected properties that the Testbed <b>cannot</b> automatically measure during your experiment, and so must be measured manually instead.</p>
    <p><b>How to add manually measured properties:</b></p>
    <ol>
        <li>Click on 'open digital object property selector'</li>
        <li>Browse the ontology of properties to find those you would like to manually measure</li>
        <li>Copy each property to your clipboard by either <b>double-clicking</b> on it or <b>drag and dropping</b> it into the clipboard</li>
        <li>For each property click on the 'true' button to select which stage of the workflow you'd like to measure the property (if your experiment only uses one service select 'true' for this)</li>
        <li>Once you have added all required properties and specified where they are to be measured click the 'add to experiment' button.</li>
    </ol>
    <a4j:region id="regionManualProps" renderRegionOnly="true">
    <h:panelGrid columns="2" styleClass="expDesignerPanel" columnClasses="doListColumn,expDesignColumn">
	    <rich:panel styleClass="expExecLogPanel">
	        <rich:dataTable value="#{NewExp_Controller.stages}" var="stage" styleClass="tbTable">
	            <rich:column> 
	                <f:facet name="header">
	                    <h:outputText value="Experiment Stage"/>
	                </f:facet>
	                <h:commandLink>
	          			<f:actionListener type="eu.planets_project.tb.gui.backing.exp.SelectStageActionListener"/>
	                	<h:outputText value="#{stage.name}" styleClass="#{ ( ExperimentBean.selectedStage.name eq stage.name ) ? 'isSelected' : 'isNotSelected'}" />
	                </h:commandLink>
	            </rich:column>
	        </rich:dataTable>
	         
	        <h:panelGroup rendered="#{ExperimentBean.selectedStage == null}">
	          Select an experiment stage to view.
	        </h:panelGroup>
	        <h:panelGroup rendered="#{ExperimentBean.selectedStage != null}">
	        <p>
	        Stage: #{ExperimentBean.selectedStage.name}
	        </p>
	        <p>
	        #{ExperimentBean.selectedStage.description}
	        </p>
	        </h:panelGroup>
	     </rich:panel>
        <rich:panel styleClass="expMeasurementPanel">
	        <rich:dataTable value="#{NewExp_Controller.manualObservables}" var="prop" rows="10" 
	        reRender="propmanual_ds" styleClass="tbTable" binding="#{NewExp_Controller.manualObsTable}"
	        id="manualMeasurmentTable">
	
	            <rich:column> 
	                <f:facet name="header">
	                    <h:outputText value="Measure"/>
	                </f:facet>
	                <h:selectBooleanCheckbox value="#{prop.selected}"  disabled="#{ExperimentBean.approved}" 
	                valueChangeListener="#{NewExp_Controller.handleManualObsSelectChangeListener}">
	                	<a4j:support event="onclick" reRender="manualMeasurmentTable" eventsQueue="foo" rendered="#{!ExperimentBean.approved}"/>
	                </h:selectBooleanCheckbox>
	            </rich:column>
	            
	            <rich:column sortBy="#{prop.type}">
	                <f:facet name="header">
	                    <h:outputText value="Type"/>
	                </f:facet>
	                <h:outputText value="#{prop.type}"/> 
	            </rich:column>
	            
	            <rich:column sortBy="#{prop.name}" sortOrder="DESCENDING">
	                <f:facet name="header">
	                    <h:outputText value="Name"/>
	                </f:facet>
	                <t:graphicImage value="/graphics/help.gif" style="float: right; padding: 1px 5px;"/>
	                <h:outputText value="#{prop.name}"/>
	                <rich:toolTip showDelay="500">
	                  <h:outputText value="#{prop.description}"/>
	                  <h:panelGroup rendered="#{prop.identifier != null}">
	                    <br/><i><h:outputText value="(URI: #{prop.identifier})"/></i>
	                  </h:panelGroup>
	                </rich:toolTip>
	            </rich:column>
	            
	            <rich:column sortBy="#{prop.unit}">
	                <f:facet name="header">
	                    <h:outputText value="Unit"/>
	                </f:facet>
	                <h:outputText value="#{prop.unit}"/> 
	            </rich:column>
	            
	            <f:facet name="footer">
	                <rich:datascroller for="manualMeasurmentTable" id="propmanual_ds" renderIfSinglePage="false"></rich:datascroller>
	            </f:facet>
	        </rich:dataTable>
    	</rich:panel>
    </h:panelGrid>
    </a4j:region>
    
    <a4j:region id="regionOntologyTreeBrowserToggle" renderRegionOnly="true">
    	<!--a4j:status for="regionOntologyTreeBrowserToggle"-->
    	<a4j:status>
    		<f:facet name="start">
        		<h:graphicImage  value="/graphics/spinner.gif"/>
    		</f:facet>
		</a4j:status>
    <!-- integrating the ontology browser -->
    <rich:simpleTogglePanel id="ontologytree" label="open digital object property selector" opened="false" switchType="ajax">
	    <a4j:region id="regionOntologyTreeBrowser" renderRegionOnly="true">
		    <ui:include src="/WEB-INF/templates/property_tree_browser.xhtml">
		       <ui:param name="Standalone" value="false" />
		       <ui:param name="experimentStages" value="#{NewExp_Controller.stages}" />
		       <ui:param name="expApproved" value="#{ExperimentBean.approved}"/>
		    </ui:include>
	    </a4j:region>
    </rich:simpleTogglePanel>
	</a4j:region>
</rich:simpleTogglePanel>
</a4j:region>

    <ui:include src="/WEB-INF/templates/exp_page_bands.xhtml">
       <ui:param name="ExperimentPhase" value="3" />
       <ui:param name="PlaceBandAsHeader" value="false" />
    </ui:include>

</a4j:form>

    <ui:include src="/WEB-INF/templates/comment_template.xhtml">
       <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
       <ui:param name="ExperimentPhase" value="3" />
    </ui:include>
                
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>
        <p>&#160;</p>

            
				</div>
			</div>
		</div>

		<div id="leftcol">

        <!-- Include the standard experiment builder sidebar. -->
        <ui:include src="/WEB-INF/templates/exp_sidebar.xhtml">
           <ui:param name="ExperimentBean" value="#{ExperimentBean}" />
           <ui:param name="ExperimentPhase" value="3" />
        </ui:include>
        
		</div>

	</ui:define>
	<ui:define name="footer">
		<ui:include src="/WEB-INF/templates/footer.xhtml" />
	</ui:define>
</ui:composition>

</body>
</html>
