<?xml version="1.0"?>

<!-- ======================================================================= -->
<!-- Testbed EJB deployer build file                                                       -->
<!-- ======================================================================= -->

<project name="Testbed EJB deployer" default="createejbar" basedir=".">

  <property environment="env"/>
  
  <property name="appName" value="testbed"/>
  <property name="war.base.name" value="${appName}.war"/>
  
  <property name="src.dir" value="${basedir}/java"/>

  <property name="src.resources" value="${basedir}/resources"/>
  <!--property name="jboss.home" value="${env.JBOSS_HOME}"/-->
  <property name="build.dir" value="${basedir}/build"/>
  <property name="build.classes.dir" value="${build.dir}/classes"/>
  
   <property name="test.dir" value="${basedir}/../test/java"/>
   <property name="client.config" value="${basedir}/../test/client-config"/>
   
   <!--To configure-->
   <property name="jboss.home" value="C:/DATA/Implementation/ifr_server"/>
   <property name="junit.lib" value="C:/Programme/Eclipse_JEE/eclipse/plugins/org.junit4_4.3.1"/>

  <!-- Build classpath -->
  <path id="classpath">
        <fileset dir="${jboss.home}/server/default/lib">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="${jboss.home}/server/default/deploy/ejb3.deployer">
            <include name="*.jar"/>
        </fileset>
        <fileset dir="${jboss.home}/server/default/deploy/jboss-aop-jdk50.deployer">
            <include name="*.jar"/>
        </fileset>
             <fileset dir="${jboss.home}/server/default/deploy/jbossweb-tomcat55.sar/jsf-libs">
        		<include name="*.jar"/>
        </fileset>
        <fileset dir="${jboss.home}/lib">
            <include name="*.jar"/>
        </fileset>
        <!--include JUNIT 4.0 lib-->
           <!--fileset dir="${junit.lib}">
            <include name="*.jar"/>
        </fileset--> 
 	<!--include our external resources as *.xml and *.props-->
	<pathelement location="${basedir}/resources"/>
	<pathelement location="${build.classes.dir}"/>
	<!-- So that we can get jndi.properties for InitialContext -->
	<pathelement location="${client.config}"/>
  </path>

  <property name="build.classpath" refid="classpath"/>

  <!-- =================================================================== -->
  <!-- Prepares the build directory                                        -->
  <!-- =================================================================== -->
  <target name="prepare" depends="clean">
    <mkdir dir="${build.dir}"/>
    <mkdir dir="${build.classes.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Compiles the source code                                            -->
  <!-- =================================================================== -->
  <target name="compile" depends="prepare">
   <echo message="ant.java.version: ${ant.java.version}" />
	<!--compile the model-->
    <javac source="1.5" 
		 srcdir="${src.dir}"
           destdir="${build.classes.dir}"
           debug="on"
           deprecation="on"
           optimize="off"
           excludes="eu/planets_project/tb/gui/**"
           includes="**">
            <classpath refid="classpath"/>
    </javac>
		<!--compile the test-classes, session beans, etc.-->
        <javac source="1.5" 
			srcdir="${test.dir}"
           destdir="${build.classes.dir}"
           debug="on"
           deprecation="on"
           optimize="off"
           includes="**">
            <classpath refid="classpath"/>
    </javac>
  </target>

  <target name="createejbjar" depends="compile">
    <jar jarfile="build/testbedmodel.jar">
      <fileset dir="${build.classes.dir}">
      	  <!--include name="com/titan/domain/*.class"/>
      	  <include name="com/titan/travelagent/*.class"/-->
      </fileset>
      <fileset dir="${src.resources}/">
          <include name="META-INF/persistence.xml"/>
      </fileset>
      <fileset dir="${src.resources}/">
          <include name="eu/planets_project/tb/impl/BenchmarkGoals.xml"/>
          <include name="eu/planets_project/tb/impl/BackendResources.properties"/>
      </fileset>
     </jar>
  </target>

 <target name="deploymodel" depends="createejbjar">
	 <copy file="build/testbedmodel.jar" todir="${jboss.home}/server/default/deploy"/>
  </target>
  
  <target name="run.client" depends="deploymodel">
    <java  classname="test.eu.planets_project.tb.Client" fork="yes" dir=".">
      <classpath refid="classpath"/>
    </java>
  </target>
  
    <target name="run.debug1">
    <java  classname="test.eu.planets_project.tb.test.Client" fork="yes" dir=".">
      <classpath refid="classpath"/>
    </java>
  </target>

  <target name="run.debug2">
    <java  classname="eu.planets_project.tb.test.Client2" fork="yes" dir=".">
      <classpath refid="classpath"/>
    </java>
  </target>
  
  <target name="run.junittests">
    <junit fork="yes" haltonfailure="yes">
		<test name="eu.planets_project.tb.unittest.model.BasicPropertiesTest" />
		<!--test name="eu.planets_project.tb.unittest.model.benchmark.BenchmarkGoalHandlerTest" /-->
		<!--test name="eu.planets_project.tb.unittest.model.benchmark.BenchmarkGoalTest" /-->
		<test name="eu.planets_project.tb.unittest.TestbedManagerTest" />
		<test name="eu.planets_project.tb.unittest.AdminManagerTest" />
		<!--test name="eu.planets_project.tb.unittest.model.ExperimentTest" /-->
		<test name="eu.planets_project.tb.unittest.model.ExperimentSetupTest" />
		<test name="eu.planets_project.tb.unittest.model.mockup.WorkflowHandlerTest" />
		<!--test name="eu.planets_project.tb.unittest.model.CommentBrowserTest" /-->
		<!--test name="eu.planets_project.tb.unittest.wizzards.WizzardFirstStage" /-->
		<formatter type="plain" usefile="false" />
		<classpath refid="classpath" />
    </junit>
  </target>
  
  <!-- =================================================================== -->
  <!-- Cleans up generated stuff on JBoss                                          -->
  <!-- =================================================================== -->
  <target name="clean.db">
    <delete dir="${jboss.home}/server/default/data/hypersonic"/>
  </target>

  <target name="clean">
    <delete dir="${build.dir}"/>
    <delete file="${jboss.home}/server/default/testbedmodel.jar"/>
  </target>

  <!-- =================================================================== -->
  <!-- Helper targets to start the JBoss in a new cmd window (on Windows)                                         -->
  <!-- =================================================================== -->
<target name="startjboss" >
  <exec dir="${jboss.home}/bin" executable="cmd.exe" spawn="true">
    <arg value="/c start run.bat"/>
  </exec>
</target>

<!-- ks -->

  <target name="makeDirectories">
    <mkdir dir="${build.dir}" />
    <mkdir dir="${build.dir}/${appName}" />
    <mkdir dir="${build.dir}/${appName}/WEB-INF/lib" />
    <mkdir dir="${build.dir}/${appName}/WEB-INF/classes" />
  </target>

  <target name="populateDirectories" depends="makeDirectories">
    <!--<copy todir="${build.dir}/${appName}/WEB-INF/lib">
        <fileset dir="lib">
            <include name="*.jar"/>
        </fileset>      
    </copy> -->
  </target>

  <target name="dist" depends="populateDirectories">

    <javac source="1.5" debug="true" srcdir="java" destdir="${build.dir}/${appName}/WEB-INF/classes">

      <classpath refid="classpath"/>

    </javac>

    <copy todir="${build.dir}/${appName}">
      <fileset dir="web" casesensitive="yes">
        <include name="**/*.*" />
      </fileset>   
    </copy>

    <copy todir="${build.dir}/${appName}/WEB-INF/classes">
      <fileset dir="${basedir}/resources">
        <include name="**/*.properties" />
        <include name="**/*.xml" />
      </fileset>   
    </copy>



    <jar jarfile="${build.dir}/${appName}.war" 
	 basedir="${build.dir}/${appName}"/>

  </target>
  
  <target name="deploy" depends="deploymodel,dist">
    <copy todir="${jboss.home}/server/default/deploy" 
          file="${build.dir}/${appName}.war" overwrite="true"/>
  </target>


</project>

